rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ===== HELPER FUNCTIONS =====
    function isOwner(fieldValue) {
      return request.auth != null && request.auth.uid == fieldValue;
    }
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }
    function incomingData() {
      return request.resource.data;
    }
    function existingData() {
      return resource.data;
    }

    // ===== PRODUCT LISTINGS (Public read, admin only write) =====
    match /product_listings/{docId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // ===== USERS =====
    match /users/{userId} {
      allow read: if true; // Public profiles
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || (isAdmin() 
                        && (!existingData().keys().hasAny(['balance']) || 
                            incomingData().balance >= existingData().balance));
      allow delete: if isAdmin();
    }

    // ===== REFERRAL SYSTEM =====
    match /refers/{referId} {
      allow read: if true;
      allow create: if isOwner(incomingData().userId)
                    && incomingData().keys().hasAll(['userId', 'referrerId', 'commission'])
                    && incomingData().commission is number
                    && incomingData().commission > 0;
      allow update, delete: if isAdmin();
    }

    // ===== USER DEPOSITS (existing + new deposits collection) =====
    match /userDeposits/{docId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(incomingData().userId)
                    && incomingData().amount > 0
                    && incomingData().status == "pending";
      allow update: if (isOwner(resource.data.userId) || isAdmin())
                    && (isAdmin() || 
                        (existingData().status == "pending" && incomingData().status == "completed"));
      allow delete: if isAdmin();
    }

    match /deposits/{docId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(incomingData().userId)
                    && incomingData().amount > 0
                    && incomingData().status == "pending";
      allow update: if isAdmin(); // Only admin approves/completes deposits
      allow delete: if isAdmin();
    }

    // ===== ORDERS + ACTIVE ORDERS =====
    match /orders/{docId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(incomingData().userId)
                    && incomingData().keys().hasAll(['userId', 'amount', 'status', 'productId'])
                    && incomingData().amount > 0
                    && incomingData().status == "pending"; // Assume starts pending
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isAdmin();
    }

    match /active_orders/{docId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create, update: if isOwner(incomingData().userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ===== CRYPTO PAYMENTS =====
    match /crypto_payments/{docId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(incomingData().userId)
                    && incomingData().amount > 0
                    && incomingData().keys().hasAll(['userId', 'amount', 'status', 'orderId']); // Adjust required fields as needed
      allow update: if isAdmin(); // Only admin marks as paid/completed
      allow delete: if isAdmin();
    }

    match /crypto_payment_history/{docId} {
      allow read, update: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(incomingData().userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ===== DEPOSIT HISTORY =====
    match /deposit_history/{docId} {
      allow read, update: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(incomingData().userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ===== BALANCE TRANSACTIONS =====
    match /balance_transactions/{docId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if (isOwner(incomingData().userId) || isAdmin())
                    && incomingData().amount is number;
      allow update, delete: if isAdmin();
    }

    // ===== GENERAL TRANSACTIONS =====
    match /transactions/{docId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(incomingData().userId) || isAdmin();
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ===== FEEDBACKS =====
    match /feedbacks/{docId} {
      allow read: if true;
      allow create: if request.auth != null
                    && incomingData().keys().hasAll(['userId', 'rating', 'message'])
                    && incomingData().rating >= 1 && incomingData().rating <= 5
                    && isOwner(incomingData().userId);
      allow update, delete: if isAdmin() || isOwner(resource.data.userId);
    }

    // ===== CHATS / MESSAGES (basic private chat rules) =====
    // Assuming chats involve two users – adjust if needed
    match /chats/{chatId} {
      allow read, write: if isAdmin() || resource.data.participants.hasAny([request.auth.uid]);
    }
    match /conversations/{convId} {
      allow read, write: if isAdmin() || isOwner(resource.data.userId);
    }
    match /messages/{msgId} {
      allow read, write: if isAdmin() || isOwner(resource.data.senderId);
    }

    // ===== OTHER COLLECTIONS (public or admin-only where appropriate) =====
    match /countries/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /restricted_countries/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /restricted_domains/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /settings/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /system_restrictions/{docId} { allow read: if true; allow write: if isAdmin(); }

    // Less sensitive logs/public data
    match /service_pricing_logs/{docId} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /in-app-msg/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /sms_orders/{docId} { allow read: if isAdmin(); allow write: if isAdmin(); }

    // Support/operator stuff – admin + involved user
    match /support_conversations/{convId} {
      allow read, write: if isAdmin() || isOwner(resource.data.userId);
    }
    match /support_messages/{msgId} {
      allow read, write: if isAdmin() || isOwner(resource.data.senderId);
    }

    // Temp/emails – limited
    match /tempEmails/{docId} { allow read, write: if isAdmin(); }
    match /user_restrictions/{docId} { allow read: if isOwner(resource.data.userId) || isAdmin(); allow write: if isAdmin(); }

    // Admin auth (keep as-is)
    match /admin-auth-email/{email} {
      allow read: if true;
      allow write: if false;
    }

    // ===== CATCH-ALL (fallback – deny everything else) =====
    match /{document=**} {
      allow read, write: if false; // Better to explicitly deny undefined paths
    }
  }
}