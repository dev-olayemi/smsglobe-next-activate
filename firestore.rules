rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== HELPER FUNCTIONS =====
    function isOwner(fieldValue) {
      return request.auth != null && request.auth.uid == fieldValue;
    }
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }
    function incomingData() {
      return request.resource.data;
    }
    function existingData() {
      return resource.data;
    }

    // ===== EXISTING RULES (unchanged) =====
    match /product_listings/{docId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /users/{userId} {
      allow read: if true;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || (isAdmin()
                        && (!existingData().keys().hasAny(['balance']) ||
                            incomingData().balance >= existingData().balance));
      allow delete: if isAdmin();
    }

    match /refers/{referId} {
      allow read: if true;
      allow create: if isOwner(incomingData().userId)
                    && incomingData().keys().hasAll(['userId', 'referrerId', 'commission'])
                    && incomingData().commission is number
                    && incomingData().commission > 0;
      allow update, delete: if isAdmin();
    }

    match /userDeposits/{docId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(incomingData().userId)
                    && incomingData().amount > 0
                    && incomingData().status == "pending";
      allow update: if (isOwner(resource.data.userId) || isAdmin())
                    && (isAdmin() ||
                        (existingData().status == "pending" && incomingData().status == "completed"));
      allow delete: if isAdmin();
    }

    match /deposits/{docId} {
      allow read: if request.auth != null;
      allow create: if isOwner(incomingData().userId)
                    && incomingData().amount > 0
                    && incomingData().status == "pending";
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    match /payments/{docId} {
      allow read: if request.auth != null;
      allow create, update, delete: if isAdmin();
    }

    match /orders/{docId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(incomingData().userId)
                    && incomingData().keys().hasAll(['userId', 'amount', 'status', 'productId'])
                    && incomingData().amount > 0
                    && incomingData().status == "pending";
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isAdmin();
    }

    match /active_orders/{docId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create, update: if isOwner(incomingData().userId) || isAdmin();
      allow delete: if isAdmin();
    }

    match /crypto_payments/{docId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(incomingData().userId)
                    && incomingData().amount > 0
                    && incomingData().keys().hasAll(['userId', 'amount', 'status', 'orderId']);
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    match /crypto_payment_history/{docId} {
      allow read, update: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(incomingData().userId) || isAdmin();
      allow delete: if isAdmin();
    }

    match /deposit_history/{docId} {
      allow read, update: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(incomingData().userId) || isAdmin();
      allow delete: if isAdmin();
    }

    match /balance_transactions/{docId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if (isOwner(incomingData().userId) || isAdmin())
                    && incomingData().amount is number;
      allow update, delete: if isAdmin();
    }

    match /transactions/{docId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(incomingData().userId) || isAdmin();
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isAdmin();
    }

    match /feedbacks/{docId} {
      allow read: if true;
      allow create: if request.auth != null
                    && incomingData().keys().hasAll(['userId', 'rating', 'message'])
                    && incomingData().rating >= 1 && incomingData().rating <= 5
                    && isOwner(incomingData().userId);
      allow update, delete: if isAdmin() || isOwner(resource.data.userId);
    }

    match /chats/{chatId} {
      allow read, write: if isAdmin() || resource.data.participants.hasAny([request.auth.uid]);
    }

    match /conversations/{convId} {
      allow read, write: if isAdmin() || isOwner(resource.data.userId);
    }

    match /messages/{msgId} {
      allow read, write: if isAdmin() || isOwner(resource.data.senderId);
    }

    match /countries/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /restricted_countries/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /restricted_domains/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /settings/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /system_restrictions/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /service_pricing_logs/{docId} { allow read: if request.auth != null; allow write: if isAdmin(); }
    match /in-app-msg/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /sms_orders/{docId} { 
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(incomingData().userId);
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isAdmin(); 
    }
    match /product_orders/{docId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(incomingData().userId);
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isAdmin();
    }
    match /activations/{docId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(incomingData().userId);
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isAdmin();
    }
    match /tempEmails/{docId} { allow read, write: if isAdmin(); }
    match /user_restrictions/{docId} { allow read: if isOwner(resource.data.userId) || isAdmin(); allow write: if isAdmin(); }
    match /user_balances/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) || isAdmin();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    match /admin-auth-email/{email} {
      allow read: if true;
      allow write: if false;
    }

    // ===== NEW/ADDED COLLECTIONS (secure defaults based on your project) =====
    // Public read-only lists (common for countries/services selection in SMS platforms)
    match /services/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // User-specific rentals/orders (owner + admin access)
    match /rentals/{docId} {
      allow read, write: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(incomingData().userId);
      allow update, delete: if isAdmin() || isOwner(resource.data.userId);
    }

    // Chat/message related (owner-based, assuming userId or senderId fields exist)
    match /UserChatSettings/{docId} {
      allow read, write: if isOwner(resource.data.userId) || isAdmin();
    }

    match /conversation/{docId} {  // Note: you have both "conversation" and "conversations" â€“ adjust if typo
      allow read, write: if isAdmin() || isOwner(resource.data.userId);
    }

    match /inbox/{docId} {
      allow read, write: if isOwner(resource.data.userId) || isAdmin();
    }

    match /operators/{docId} {
      allow read: if true;  // Assuming operators are public or semi-public
      allow write: if isAdmin();
    }

    match /support_conversations/{convId} {
      allow read, write: if isAdmin() || isOwner(resource.data.userId);
    }

    match /support_messages/{msgId} {
      allow read, write: if isAdmin() || isOwner(resource.data.senderId);
    }

    // ===== CATCH-ALL (strict deny for anything undefined) =====
    match /{document=**} {
      allow read, write: if false;
    }
  }
}